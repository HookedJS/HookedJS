<!DOCTYPE html>
<html>

<head>
	<title>SERVERLESS-FULLSTACK</title>
	<style>
		body { width: 650px; margin: auto }
		h1 { text-align: center }
		.resources>h2 { margin-bottom: 0 }
		.resource>h3,.resource>p { display: inline-block; margin-bottom: 0.5rem; }
		.resource>code {
			display: block;
			background-color: #eff0f1;
			color: #393318;
			padding: 5px;
			font-family: Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, sans-serif;
			white-space: nowrap;
			overflow-x: auto;
		}
		form { margin-bottom: 1rem }
		.form-group { padding-bottom: 1rem }
		label { display: block }
	</style>
</head>

<body>
	<h1>SERVERLESS-FULLSTACK</h1>
	<p>Welcome to your AWS serverless application. This example application has several resources configured for you to
		explore.
	</p>
	<section class="resources">
		<h2>Resources</h2>
		<section class="resource">
			<h3><a class="resource-example-link" href="/api/dbtime">GET /api/dbtime</a></h3>
			<p> &nbsp;Gets the current time from DB</p>
			<code>curl https://0.0.0.0:3000/api/dbtime</code>
		</section>
		<section class="resource">
			<h3>POST /files/:id</h3>
			<p> &nbsp;Uploads a file</p>
			<code>curl -X POST https://0.0.0.0:3000/files/1234 --form file=@image.jpg</code>
		</section>
		<section class="resource">
			<h3>GET /files/:id</h3>
			<p> &nbsp;Returns a file</p>
			<code>curl https://0.0.0.0:3000/files/1234</code>
		</section>
		<section class="resource">
			<h3>GET /files/:id/meta</h3>
			<p> &nbsp;Returns a file's metadata</p>
			<code>curl https://0.0.0.0:3000/files/1234/meta -H 'accept: application/json'</code>
		</section>
		<section class="resource">
			<h3>POST /api/users</h3>
			<p> &nbsp;Creates a user</p>
			<code>
				curl -X POST --url https://0.0.0.0:3000/api/users --header 'Content-Type: application/json' --data '{"email": "editor3@example.com","roles": [1],"givenName": "Sally","surname": "Editor","password": "Password88"}'
			</code>
		</section>
		<section class="resource">
			<h3><a class="resource-example-link" href="/api/users">GET /api/users</a></h3>
			<p> &nbsp;Gets users</p>
			<code>curl https://0.0.0.0:3000/api/users</code>
		</section>
	</section>
	<section class="form">
		<h2>Multi-part Form</h2>
		<p>Experiment with uploading a file via the form below to file id = '1234'.</p>
		<form action="/api/crud/files/1234/bin" method="post" enctype="multipart/form-data">
			<div class="form-group">
				<input aria-label="File picker" type="file" name="file" id="file">
			</div>
			<input type="submit">
		</form>
	</section>
	<section class="form">
		<h2>Ajax Form</h2>
		<form action="#" id="ajax-form" method="post" onsubmit="onAjaxSubmit(event)">
			<div class="form-group">
				<input aria-label="File picker" type="file" name="file" id="file2">
			</div>
			<input type="submit">
		</form>

		<script>
			async function onAjaxSubmit(event) {
				event.preventDefault()
				const json = await formToJson(event.target)
				console.log(json.file)
			}

			async function formToJson(formElement) {
				const reqBody = {}
				for (const e of formElement.elements) {
					if (e.type === 'submit') continue
					reqBody[e.name] = (
						e.type === 'checkbox' && e.checked ||
						e.type === 'file' && await readFile(e.files[0]) ||
						e.value
					)
				}
				return reqBody
			}

			function readFile(file) {
				return new Promise((resolve, reject) => {
					var fr = new FileReader();
					// fr.onload = () => resolve(fr.result)
					fr.onerror = reject
					fr.readAsDataURL(file)
					fr.onload = () => {
						// Encoding fixes thanks to https://stackoverflow.com/a/52311051/1202757
						let encoded = fr.result.toString().replace(/^data:(.*,)?/, '');
						if ((encoded.length % 4) > 0) {
							encoded += '='.repeat(4 - (encoded.length % 4));
						}
						resolve(encoded);
					};
				})
			}

		</script>
	</section>
</body>

</html>